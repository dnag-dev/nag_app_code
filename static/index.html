<!DOCTYPE html>
<!-- Nag Digital Twin v2.0.0 - Safari Compatible -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nag - The Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="/static/styles.css">
  <!-- Core script loads all other modules in the correct sequence -->
  <script src="/static/nag-core.js"></script>
  <script src="/static/nag-audio.js"></script>
  <script src="/static/nag-recording.js"></script>
  <script src="/static/nag-transcription.js"></script>
  <script src="/static/nag-ui.js"></script>
  <script src="/static/nag-utils.js"></script>
</head>
<body>
  <div id="app-container">
    <h1>Welcome to Nag 2.0</h1>
    <p>Dinakara's mind â€” therapist, companion, unfiltered mirror.</p>
    
    <div id="orb" class="idle">
      <div id="volume-indicator">
        <div class="volume-bar" style="height: 0"></div>
      </div>
    </div>
    
    <audio id="audio" hidden></audio>
    
    <div id="controls">
      <button id="toggle-btn" class="btn">Start Conversation</button>
      <button id="pause-btn" class="btn" disabled>Pause</button>
    </div>
    
    <div class="walkie-talkie-hint" id="mode-hint">Click &amp; hold the orb to use walkie-talkie mode</div>
    <button id="mode-toggle">Switch to continuous mode</button>
    
    <div id="status" class="status"></div>
    <div id="debug"><strong>Debug Log:</strong></div>
    <div class="version">v2.0.0</div>
  </div>

  <script>
    // WebSocket connection
    let ws = null;
    let isConnected = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const RECONNECT_DELAY = 5000; // 5 seconds

    function connectWebSocket() {
      if (ws) {
        ws.close();
      }

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
      
      ws.onopen = () => {
        isConnected = true;
        reconnectAttempts = 0;
        updateStatus('Connected to server', 'success');
        console.log('WebSocket connection established');
      };
      
      ws.onclose = (event) => {
        isConnected = false;
        console.log('WebSocket closed:', event.code, event.reason);
        
        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          reconnectAttempts++;
          updateStatus(`Disconnected. Reconnecting in ${RECONNECT_DELAY/1000} seconds... (Attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'info');
          setTimeout(connectWebSocket, RECONNECT_DELAY);
        } else {
          updateStatus('Failed to connect to server after multiple attempts', 'error');
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('Connection error occurred', 'error');
      };
      
      ws.onmessage = (event) => {
        console.log('Received:', event.data);
        try {
          const data = JSON.parse(event.data);
          // Handle incoming messages based on their type
          if (data.type === 'status') {
            updateStatus(data.message, data.status || 'info');
          }
        } catch (e) {
          console.error('Error parsing message:', e);
        }
      };
    }

    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }

    // Initialize WebSocket connection when the page loads
    window.addEventListener('load', () => {
      connectWebSocket();
      
      // Add error handling for static resources
      document.querySelectorAll('script').forEach(script => {
        script.onerror = () => {
          updateStatus(`Failed to load ${script.src}`, 'error');
        };
      });
    });

    // Reconnect on visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !isConnected) {
        connectWebSocket();
      }
    });
  </script>
</body>
</html>